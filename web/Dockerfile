FROM docker.io/library/debian:bookworm-slim

# –ê—Ä–≥—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏
ARG JITSI_RELEASE=stable

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV S6_BEHAVIOUR_IF_STAGE2_FAILS=2

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–±–µ–∑ apt-dpkg-wrap) –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
RUN dpkgArch="$(dpkg --print-architecture)" && \
    case "${dpkgArch##*-}" in \
        "amd64") TPL_ARCH=amd64; S6_ARCH=amd64 ;; \
        "arm64") TPL_ARCH=arm64; S6_ARCH=aarch64 ;; \
        *) echo "unsupported architecture"; exit 1 ;; \
    esac && \
    apt-get update && \
    apt-get install -y \
        apt-transport-https \
        apt-utils \
        ca-certificates \
        gnupg \
        wget \
        curl \
        openssh-client \
        lsb-release \
        make \
        unzip \
        nginx-extras \
        socat \
        cron \
        dnsutils \
        jq \
        procps \
        vim \
        iputils-ping \
        net-tools && \
    rm -rf /var/lib/apt/lists/*  # –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ APT

# –î–æ–±–∞–≤–ª—è–µ–º acme.sh
ADD https://raw.githubusercontent.com/acmesh-official/acme.sh/3.0.7/acme.sh /opt

# üìå **–ó–∞–≥—Ä—É–∂–∞–µ–º –≥–æ—Ç–æ–≤—É—é —Å–±–æ—Ä–∫—É**
COPY docker_build.tar.gz /tmp/docker_build.tar.gz

# üìå **–†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –≤ –Ω—É–∂–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é**
RUN mkdir -p /usr/share/jitsi-meet && \
    tar -xzf /tmp/docker_build.tar.gz -C /usr/share/jitsi-meet && \
    rm /tmp/docker_build.tar.gz

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º tpl
RUN wget -qO /usr/bin/tpl "https://github.com/jitsi/tpl/releases/download/v1.4.0/tpl-linux-${TPL_ARCH}" && \
    chmod +x /usr/bin/tpl

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º S6 overlay
RUN wget -qO /tmp/s6.tar.gz "https://github.com/just-containers/s6-overlay/releases/download/v1.22.1.0/s6-overlay-${S6_ARCH}.tar.gz" && \
    mkdir /tmp/s6 && \
    tar xfz /tmp/s6.tar.gz -C /tmp/s6 && \
    tar hxfz /tmp/s6.tar.gz -C / && \
    rm -f /usr/bin/execlineb && \
    cp /tmp/s6/bin/execlineb /usr/bin/ && \
    rm -rf /tmp/s6*

# üìå **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ Jitsi (–µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω—É–∂–Ω—ã)**
RUN wget -qO - "https://download.jitsi.org/jitsi-key.gpg.key" | gpg --dearmour > /etc/apt/trusted.gpg.d/jitsi.gpg && \
    echo "deb https://download.jitsi.org $JITSI_RELEASE/" > /etc/apt/sources.list.d/jitsi.list && \
    echo "deb http://ftp.debian.org/debian bookworm-backports main" > /etc/apt/sources.list.d/backports.list && \
    apt-get update && \
    apt-get dist-upgrade -y && \
    rm -rf /var/lib/apt/lists/*

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã
EXPOSE 80 443

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ—á–∫–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
VOLUME ["/config", "/usr/share/jitsi-meet/transcripts"]

# –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞
ENTRYPOINT [ "/init" ]
