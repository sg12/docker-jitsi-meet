#!/usr/bin/with-contenv bash

PROSODY_CFG="/config/prosody.cfg.lua"

mkdir -p /config/certs /config/conf.d
cp -rn /defaults/* /config

sed -e "s|\${XMPP_AUTH_DOMAIN}|${XMPP_AUTH_DOMAIN:-auth.meet.jitsi}|g" \
    -e "s|\${XMPP_DOMAINS}|${XMPP_DOMAINS}|g" \
    -e "s|\${XMPP_DOMAINS%%,\*}|${XMPP_DOMAINS%%,*}|g" \
    /defaults/prosody.cfg.lua > "$PROSODY_CFG"

# Генерация сертификатов
if [[ ! -f /config/certs/auth.meet.jitsi.crt ]]; then
    echo "Generating certificate for auth.meet.jitsi"
    prosodyctl --config "$PROSODY_CFG" cert generate auth.meet.jitsi
    cp /var/lib/prosody/auth.meet.jitsi.crt /config/certs/auth.meet.jitsi.crt
    cp /var/lib/prosody/auth.meet.jitsi.key /config/certs/auth.meet.jitsi.key
    chown prosody:prosody /config/certs/auth.meet.jitsi.{crt,key}
    chmod 640 /config/certs/auth.meet.jitsi.{crt,key}
fi

if [[ ! -f /config/certs/jitsi-connectrm-test.ru.crt ]]; then
    echo "Generating certificate for jitsi-connectrm-test.ru"
    prosodyctl --config "$PROSODY_CFG" cert generate jitsi-connectrm-test.ru
    cp /var/lib/prosody/jitsi-connectrm-test.ru.crt /config/certs/jitsi-connectrm-test.ru.crt
    cp /var/lib/prosody/jitsi-connectrm-test.ru.key /config/certs/jitsi-connectrm-test.ru.key
    chown prosody:prosody /config/certs/jitsi-connectrm-test.ru.{crt,key}
    chmod 640 /config/certs/jitsi-connectrm-test.ru.{crt,key}
fi

chown prosody:prosody "$PROSODY_CFG"
chmod 644 "$PROSODY_CFG"
